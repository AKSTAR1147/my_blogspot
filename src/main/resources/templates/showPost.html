<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>My Personal Blog</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body {
            font-family: 'Georgia', serif;
            background: #fafafa;
            color: #333;
        }
        header {
            padding: 20px 40px;
            border-bottom: 1px solid #ddd;
            background: #fff;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        header h1 { font-size: 22px; font-weight: bold; margin: 0; }
        .blog-meta { font-size: 14px; color: #777; margin-bottom: 15px; }
        .post-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .btn-action {
            display: inline-block;
            border: 1px solid #333;
            background: #fff;
            cursor: pointer;
            font-size: 14px;
            padding: 6px 14px;
            border-radius: 4px;
            text-align: center;
        }
        .btn-action:hover {
            background: #f5f5f5;
        }
        /* Comment drawer styles */
        .comment-toggle { display: none; }
        .comment-drawer {
            position: fixed; top: 0; right: -400px; width: 400px; height: 100%;
            background: #fff; box-shadow: -2px 0 10px rgba(0,0,0,0.2);
            padding: 20px; overflow-y: auto;
            transition: right 0.3s ease; z-index: 2000;
        }
        .comment-toggle:checked ~ .comment-drawer {
            right: 0;
        }
        .drawer-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5);
            display: none; z-index: 1500;
        }
        .comment-toggle:checked ~ .drawer-overlay {
            display: block;
        }
    </style>
</head>
<body>
<header>
    <div class="d-flex justify-content-between align-items-center mb-2">
        <h1>ðŸŒ¿ My Blog</h1>
    </div>
</header>

<div class="container mt-4">
    <div th:object="${post}">

        <input type="checkbox" id="comments-toggle" class="comment-toggle">

        <div class="card mb-4 shadow-sm">
            <div class="card-body">
                <h3 th:text="${post.title}"></h3>
                <div class="blog-meta">
                    By: <strong th:text="${post.author}"></strong><br>
                    Published: <span th:text="${post.createdAt}"></span>
                </div>
                <p th:text="${post.content}"
                   style="white-space: pre-wrap; text-align: justify; font-family: var(--bs-font-monospace);">
                </p>
                <div class="post-actions">
                    <form th:action="@{/post/{id}/like(id=${post.id})}" method="post" style="display:inline;">
                        <button type="submit" class="btn-action">
                            <span th:text="${post.likes.size()} + ' Like'">Like</span>
                        </button>
                    </form>
                    <label for="comments-toggle" class="btn-action">
                        <span th:text="${post.comments.size()} + ' comments'"></span>
                    </label>
                </div>
            </div>
        </div>

        <div class="comment-drawer">
            <!-- ========== MODIFIED HEADER WITH LOGOUT BUTTON ========== -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>Comments</h4>
                <!-- This div will only appear if a user is logged in -->
                <div sec:authorize="isAuthenticated()">
                    <form th:action="@{/logout}" method="post" class="m-0">
                        <button type="submit" class="btn btn-sm btn-outline-secondary" title="Logout">
                            <i class="bi bi-box-arrow-right"></i> Logout
                        </button>
                    </form>
                </div>
            </div>
            <!-- ======================================================= -->

            <div th:if="${post.comments.size() == 0}">
                <p>No comments yet</p>
            </div>
            <div th:each="comment : ${post.comments}" class="border-bottom mb-2 pb-2">
                <p th:text="${comment.content}"></p>
                <small style="font-style: italic;" th:text="'- ' + ${comment.author}"></small>
            </div>

            <hr>

            <div class="comment-section mt-3">
                <div sec:authorize="!isAuthenticated()">
                    <p>Want to leave a comment?</p>
                    <a th:href="@{/oauth2/authorization/google}" class="btn btn-danger w-100">
                        <i class="bi bi-google"></i> Login with Google
                    </a>
                </div>

                <div sec:authorize="isAuthenticated()">
                    <form th:action="@{/post/{id}/comment(id=${post.id})}" method="post">
                        <div class="mb-3">
                            <textarea class="form-control" name="content" rows="3" placeholder="Write a comment..." required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Post Comment</button>
                    </form>
                </div>
            </div>
            <label for="comments-toggle" class="btn btn-secondary mt-3 w-100">Close</label>
        </div>

        <label for="comments-toggle" class="drawer-overlay"></label>
    </div>
</div>
</body>
</html>